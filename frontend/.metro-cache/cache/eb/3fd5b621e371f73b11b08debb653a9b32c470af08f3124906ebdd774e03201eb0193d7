{"dependencies":[{"name":"@babel/runtime/helpers/interopRequireDefault","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":87,"column":62,"index":4005}}],"key":"7kvm5yrOpz4NYiDi6sn4qxa8DVQ="}},{"name":"abort-controller/polyfill","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":35,"index":35}}],"key":"Y+bCVn4lNYorNpf/8Rmj//JPTV8="}},{"name":"expo-modules-core","data":{"asyncType":null,"locs":[{"start":{"line":2,"column":0,"index":36},"end":{"line":2,"column":56,"index":92}}],"key":"ka0FS6s7ZmvhJq+hEjGkLLrGpyo="}},{"name":"./ServerRegistrationModule","data":{"asyncType":null,"locs":[{"start":{"line":3,"column":0,"index":93},"end":{"line":3,"column":66,"index":159}}],"key":"YAseH1nZMP5R9yUhA4v25OdgZPM="}},{"name":"./TokenEmitter","data":{"asyncType":null,"locs":[{"start":{"line":4,"column":0,"index":160},"end":{"line":4,"column":54,"index":214}}],"key":"XhbMIyVddqi3lxqapEb19TI+9J4="}},{"name":"./getDevicePushTokenAsync","data":{"asyncType":null,"locs":[{"start":{"line":5,"column":0,"index":215},"end":{"line":5,"column":64,"index":279}}],"key":"B0eKcuACAajVW/NB6G4UhlxBwZ0="}},{"name":"./utils/updateDevicePushTokenAsync","data":{"asyncType":null,"locs":[{"start":{"line":6,"column":0,"index":280},"end":{"line":6,"column":120,"index":400}}],"key":"8k3LD8RVmvq6rgns3ACBQxVq3xk="}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  var _interopRequireDefault = require(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\");\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.__handlePersistedRegistrationInfoAsync = __handlePersistedRegistrationInfoAsync;\n  exports.setAutoServerRegistrationEnabledAsync = setAutoServerRegistrationEnabledAsync;\n  require(_dependencyMap[1], \"abort-controller/polyfill\");\n  var _expoModulesCore = require(_dependencyMap[2], \"expo-modules-core\");\n  var _ServerRegistrationModule = _interopRequireDefault(require(_dependencyMap[3], \"./ServerRegistrationModule\"));\n  var _TokenEmitter = require(_dependencyMap[4], \"./TokenEmitter\");\n  var _getDevicePushTokenAsync = _interopRequireDefault(require(_dependencyMap[5], \"./getDevicePushTokenAsync\"));\n  var _updateDevicePushTokenAsync = require(_dependencyMap[6], \"./utils/updateDevicePushTokenAsync\");\n  let lastAbortController = null;\n  async function updatePushTokenAsync(token) {\n    // Abort current update process\n    lastAbortController?.abort();\n    lastAbortController = new AbortController();\n    return await (0, _updateDevicePushTokenAsync.updateDevicePushTokenAsync)(lastAbortController.signal, token);\n  }\n  /**\n   * Sets the registration information so that the device push token gets pushed\n   * to the given registration endpoint\n   * @param enabled\n   */\n  async function setAutoServerRegistrationEnabledAsync(enabled) {\n    // We are overwriting registration, so we shouldn't let\n    // any pending request complete.\n    lastAbortController?.abort();\n    if (!_ServerRegistrationModule.default.setRegistrationInfoAsync) {\n      throw new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'setRegistrationInfoAsync');\n    }\n    await _ServerRegistrationModule.default.setRegistrationInfoAsync(enabled ? JSON.stringify({\n      isEnabled: enabled\n    }) : null);\n  }\n  // note(Chmiela): This function is exported only for testing purposes.\n  async function __handlePersistedRegistrationInfoAsync(registrationInfo) {\n    if (!registrationInfo) {\n      // No registration info, nothing to do\n      return;\n    }\n    let registration = null;\n    try {\n      registration = JSON.parse(registrationInfo);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while fetching registration information for auto token updates.', e);\n    }\n    if (!registration?.isEnabled) {\n      // Registration is invalid or not enabled, nothing more to do\n      return;\n    }\n    try {\n      // Since the registration is enabled, fetching a \"new\" device token\n      // shouldn't be a problem.\n      const latestDevicePushToken = await (0, _getDevicePushTokenAsync.default)();\n      await updatePushTokenAsync(latestDevicePushToken);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n    }\n  }\n  if (_ServerRegistrationModule.default.getRegistrationInfoAsync) {\n    // A global scope (to get all the updates) device push token\n    // subscription, never cleared.\n    (0, _TokenEmitter.addPushTokenListener)(async token => {\n      try {\n        // Before updating the push token on server we always check if we should\n        // Since modules can't change their method availability while running, we\n        // can assert it's defined.\n        const registrationInfo = await _ServerRegistrationModule.default.getRegistrationInfoAsync();\n        if (!registrationInfo) {\n          // Registration is not enabled\n          return;\n        }\n        const registration = JSON.parse(registrationInfo);\n        if (registration?.isEnabled) {\n          // Dispatch an abortable task to update\n          // registration with new token.\n          await updatePushTokenAsync(token);\n        }\n      } catch (e) {\n        console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n      }\n    });\n    // Verify if persisted registration\n    // has successfully uploaded last known\n    // device push token. If not, retry.\n    _ServerRegistrationModule.default.getRegistrationInfoAsync().then(__handlePersistedRegistrationInfoAsync);\n  } else {\n    console.warn(`[expo-notifications] Error encountered while fetching auto-registration state, new tokens will not be automatically registered on server.`, new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'getRegistrationInfoAsync'));\n  }\n});","lineCount":92,"map":[[8,2,1,0,"require"],[8,9,1,0],[8,10,1,0,"_dependencyMap"],[8,24,1,0],[9,2,2,0],[9,6,2,0,"_expoModulesCore"],[9,22,2,0],[9,25,2,0,"require"],[9,32,2,0],[9,33,2,0,"_dependencyMap"],[9,47,2,0],[10,2,3,0],[10,6,3,0,"_ServerRegistrationModule"],[10,31,3,0],[10,34,3,0,"_interopRequireDefault"],[10,56,3,0],[10,57,3,0,"require"],[10,64,3,0],[10,65,3,0,"_dependencyMap"],[10,79,3,0],[11,2,4,0],[11,6,4,0,"_TokenEmitter"],[11,19,4,0],[11,22,4,0,"require"],[11,29,4,0],[11,30,4,0,"_dependencyMap"],[11,44,4,0],[12,2,5,0],[12,6,5,0,"_getDevicePushTokenAsync"],[12,30,5,0],[12,33,5,0,"_interopRequireDefault"],[12,55,5,0],[12,56,5,0,"require"],[12,63,5,0],[12,64,5,0,"_dependencyMap"],[12,78,5,0],[13,2,6,0],[13,6,6,0,"_updateDevicePushTokenAsync"],[13,33,6,0],[13,36,6,0,"require"],[13,43,6,0],[13,44,6,0,"_dependencyMap"],[13,58,6,0],[14,2,7,0],[14,6,7,4,"lastAbortController"],[14,25,7,23],[14,28,7,26],[14,32,7,30],[15,2,8,0],[15,17,8,15,"updatePushTokenAsync"],[15,37,8,35,"updatePushTokenAsync"],[15,38,8,36,"token"],[15,43,8,41],[15,45,8,43],[16,4,9,4],[17,4,10,4,"lastAbortController"],[17,23,10,23],[17,25,10,25,"abort"],[17,30,10,30],[17,31,10,31],[17,32,10,32],[18,4,11,4,"lastAbortController"],[18,23,11,23],[18,26,11,26],[18,30,11,30,"AbortController"],[18,45,11,45],[18,46,11,46],[18,47,11,47],[19,4,12,4],[19,11,12,11],[19,17,12,17],[19,21,12,17,"updateDevicePushTokenAsyncWithSignal"],[19,75,12,53],[19,77,12,54,"lastAbortController"],[19,96,12,73],[19,97,12,74,"signal"],[19,103,12,80],[19,105,12,82,"token"],[19,110,12,87],[19,111,12,88],[20,2,13,0],[21,2,14,0],[22,0,15,0],[23,0,16,0],[24,0,17,0],[25,0,18,0],[26,2,19,7],[26,17,19,22,"setAutoServerRegistrationEnabledAsync"],[26,54,19,59,"setAutoServerRegistrationEnabledAsync"],[26,55,19,60,"enabled"],[26,62,19,67],[26,64,19,69],[27,4,20,4],[28,4,21,4],[29,4,22,4,"lastAbortController"],[29,23,22,23],[29,25,22,25,"abort"],[29,30,22,30],[29,31,22,31],[29,32,22,32],[30,4,23,4],[30,8,23,8],[30,9,23,9,"ServerRegistrationModule"],[30,42,23,33],[30,43,23,34,"setRegistrationInfoAsync"],[30,67,23,58],[30,69,23,60],[31,6,24,8],[31,12,24,14],[31,16,24,18,"UnavailabilityError"],[31,52,24,37],[31,53,24,38],[31,79,24,64],[31,81,24,66],[31,107,24,92],[31,108,24,93],[32,4,25,4],[33,4,26,4],[33,10,26,10,"ServerRegistrationModule"],[33,43,26,34],[33,44,26,35,"setRegistrationInfoAsync"],[33,68,26,59],[33,69,26,60,"enabled"],[33,76,26,67],[33,79,26,70,"JSON"],[33,83,26,74],[33,84,26,75,"stringify"],[33,93,26,84],[33,94,26,85],[34,6,26,87,"isEnabled"],[34,15,26,96],[34,17,26,98,"enabled"],[35,4,26,106],[35,5,26,107],[35,6,26,108],[35,9,26,111],[35,13,26,115],[35,14,26,116],[36,2,27,0],[37,2,28,0],[38,2,29,7],[38,17,29,22,"__handlePersistedRegistrationInfoAsync"],[38,55,29,60,"__handlePersistedRegistrationInfoAsync"],[38,56,29,61,"registrationInfo"],[38,72,29,77],[38,74,29,79],[39,4,30,4],[39,8,30,8],[39,9,30,9,"registrationInfo"],[39,25,30,25],[39,27,30,27],[40,6,31,8],[41,6,32,8],[42,4,33,4],[43,4,34,4],[43,8,34,8,"registration"],[43,20,34,20],[43,23,34,23],[43,27,34,27],[44,4,35,4],[44,8,35,8],[45,6,36,8,"registration"],[45,18,36,20],[45,21,36,23,"JSON"],[45,25,36,27],[45,26,36,28,"parse"],[45,31,36,33],[45,32,36,34,"registrationInfo"],[45,48,36,50],[45,49,36,51],[46,4,37,4],[46,5,37,5],[46,6,38,4],[46,13,38,11,"e"],[46,14,38,12],[46,16,38,14],[47,6,39,8,"console"],[47,13,39,15],[47,14,39,16,"warn"],[47,18,39,20],[47,19,39,21],[47,123,39,125],[47,125,39,127,"e"],[47,126,39,128],[47,127,39,129],[48,4,40,4],[49,4,41,4],[49,8,41,8],[49,9,41,9,"registration"],[49,21,41,21],[49,23,41,23,"isEnabled"],[49,32,41,32],[49,34,41,34],[50,6,42,8],[51,6,43,8],[52,4,44,4],[53,4,45,4],[53,8,45,8],[54,6,46,8],[55,6,47,8],[56,6,48,8],[56,12,48,14,"latestDevicePushToken"],[56,33,48,35],[56,36,48,38],[56,42,48,44],[56,46,48,44,"getDevicePushTokenAsync"],[56,78,48,67],[56,80,48,68],[56,81,48,69],[57,6,49,8],[57,12,49,14,"updatePushTokenAsync"],[57,32,49,34],[57,33,49,35,"latestDevicePushToken"],[57,54,49,56],[57,55,49,57],[58,4,50,4],[58,5,50,5],[58,6,51,4],[58,13,51,11,"e"],[58,14,51,12],[58,16,51,14],[59,6,52,8,"console"],[59,13,52,15],[59,14,52,16,"warn"],[59,18,52,20],[59,19,52,21],[59,125,52,127],[59,127,52,129,"e"],[59,128,52,130],[59,129,52,131],[60,4,53,4],[61,2,54,0],[62,2,55,0],[62,6,55,4,"ServerRegistrationModule"],[62,39,55,28],[62,40,55,29,"getRegistrationInfoAsync"],[62,64,55,53],[62,66,55,55],[63,4,56,4],[64,4,57,4],[65,4,58,4],[65,8,58,4,"addPushTokenListener"],[65,42,58,24],[65,44,58,25],[65,50,58,32,"token"],[65,55,58,37],[65,59,58,42],[66,6,59,8],[66,10,59,12],[67,8,60,12],[68,8,61,12],[69,8,62,12],[70,8,63,12],[70,14,63,18,"registrationInfo"],[70,30,63,34],[70,33,63,37],[70,39,63,43,"ServerRegistrationModule"],[70,72,63,67],[70,73,63,68,"getRegistrationInfoAsync"],[70,97,63,92],[70,98,63,93],[70,99,63,94],[71,8,64,12],[71,12,64,16],[71,13,64,17,"registrationInfo"],[71,29,64,33],[71,31,64,35],[72,10,65,16],[73,10,66,16],[74,8,67,12],[75,8,68,12],[75,14,68,18,"registration"],[75,26,68,30],[75,29,68,33,"JSON"],[75,33,68,37],[75,34,68,38,"parse"],[75,39,68,43],[75,40,68,44,"registrationInfo"],[75,56,68,60],[75,57,68,61],[76,8,69,12],[76,12,69,16,"registration"],[76,24,69,28],[76,26,69,30,"isEnabled"],[76,35,69,39],[76,37,69,41],[77,10,70,16],[78,10,71,16],[79,10,72,16],[79,16,72,22,"updatePushTokenAsync"],[79,36,72,42],[79,37,72,43,"token"],[79,42,72,48],[79,43,72,49],[80,8,73,12],[81,6,74,8],[81,7,74,9],[81,8,75,8],[81,15,75,15,"e"],[81,16,75,16],[81,18,75,18],[82,8,76,12,"console"],[82,15,76,19],[82,16,76,20,"warn"],[82,20,76,24],[82,21,76,25],[82,127,76,131],[82,129,76,133,"e"],[82,130,76,134],[82,131,76,135],[83,6,77,8],[84,4,78,4],[84,5,78,5],[84,6,78,6],[85,4,79,4],[86,4,80,4],[87,4,81,4],[88,4,82,4,"ServerRegistrationModule"],[88,37,82,28],[88,38,82,29,"getRegistrationInfoAsync"],[88,62,82,53],[88,63,82,54],[88,64,82,55],[88,65,82,56,"then"],[88,69,82,60],[88,70,82,61,"__handlePersistedRegistrationInfoAsync"],[88,108,82,99],[88,109,82,100],[89,2,83,0],[89,3,83,1],[89,9,84,5],[90,4,85,4,"console"],[90,11,85,11],[90,12,85,12,"warn"],[90,16,85,16],[90,17,85,17],[90,156,85,156],[90,158,85,158],[90,162,85,162,"UnavailabilityError"],[90,198,85,181],[90,199,85,182],[90,225,85,208],[90,227,85,210],[90,253,85,236],[90,254,85,237],[90,255,85,238],[91,2,86,0],[92,0,86,1]],"functionMap":{"names":["<global>","updatePushTokenAsync","setAutoServerRegistrationEnabledAsync","__handlePersistedRegistrationInfoAsync","addPushTokenListener$argument_0"],"mappings":"AAA;ACO;CDK;OEM;CFQ;OGE;CHyB;yBII;KJoB"}},"type":"js/module"}]}