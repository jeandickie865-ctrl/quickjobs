{"dependencies":[{"name":"abort-controller/polyfill","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":35,"index":35}}],"key":"Zt445sKJeaqmd3t2yOR0GF+G/L0=","exportNames":["*"],"imports":1}},{"name":"expo-modules-core","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":36},"end":{"line":2,"column":56,"index":92}}],"key":"fU8WLIPqoAGygnPbZ/QJiQQfXEY=","exportNames":["*"],"imports":1}},{"name":"./ServerRegistrationModule","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":93},"end":{"line":3,"column":66,"index":159}}],"key":"OTliNP9lxRDJOLdh5XsGIjq12GA=","exportNames":["*"],"imports":1}},{"name":"./TokenEmitter","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":160},"end":{"line":4,"column":54,"index":214}}],"key":"5j/AymtYsxXL7qVrWh9rwW/7ePw=","exportNames":["*"],"imports":1}},{"name":"./getDevicePushTokenAsync","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":215},"end":{"line":5,"column":64,"index":279}}],"key":"XdMNnezmMyUe2eZLOsw/aE7Mhfk=","exportNames":["*"],"imports":1}},{"name":"./utils/updateDevicePushTokenAsync","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":6,"column":0,"index":280},"end":{"line":6,"column":120,"index":400}}],"key":"153jXZ66s6HybIv8YrABEWMrDwY=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  function _interopDefault(e) {\n    return e && e.__esModule ? e : {\n      default: e\n    };\n  }\n  exports.setAutoServerRegistrationEnabledAsync = setAutoServerRegistrationEnabledAsync;\n  exports.__handlePersistedRegistrationInfoAsync = __handlePersistedRegistrationInfoAsync;\n  require(_dependencyMap[0], \"abort-controller/polyfill\");\n  var _expoModulesCore = require(_dependencyMap[1], \"expo-modules-core\");\n  var _ServerRegistrationModule = require(_dependencyMap[2], \"./ServerRegistrationModule\");\n  var ServerRegistrationModule = _interopDefault(_ServerRegistrationModule);\n  var _TokenEmitter = require(_dependencyMap[3], \"./TokenEmitter\");\n  var _getDevicePushTokenAsync = require(_dependencyMap[4], \"./getDevicePushTokenAsync\");\n  var getDevicePushTokenAsync = _interopDefault(_getDevicePushTokenAsync);\n  var _utilsUpdateDevicePushTokenAsync = require(_dependencyMap[5], \"./utils/updateDevicePushTokenAsync\");\n  let lastAbortController = null;\n  async function updatePushTokenAsync(token) {\n    // Abort current update process\n    lastAbortController?.abort();\n    lastAbortController = new AbortController();\n    return await (0, _utilsUpdateDevicePushTokenAsync.updateDevicePushTokenAsync)(lastAbortController.signal, token);\n  }\n  /**\n   * Sets the registration information so that the device push token gets pushed\n   * to the given registration endpoint\n   * @param enabled\n   */\n  async function setAutoServerRegistrationEnabledAsync(enabled) {\n    // We are overwriting registration, so we shouldn't let\n    // any pending request complete.\n    lastAbortController?.abort();\n    if (!ServerRegistrationModule.default.setRegistrationInfoAsync) {\n      throw new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'setRegistrationInfoAsync');\n    }\n    await ServerRegistrationModule.default.setRegistrationInfoAsync(enabled ? JSON.stringify({\n      isEnabled: enabled\n    }) : null);\n  }\n  // note(Chmiela): This function is exported only for testing purposes.\n  async function __handlePersistedRegistrationInfoAsync(registrationInfo) {\n    if (!registrationInfo) {\n      // No registration info, nothing to do\n      return;\n    }\n    let registration = null;\n    try {\n      registration = JSON.parse(registrationInfo);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while fetching registration information for auto token updates.', e);\n    }\n    if (!registration?.isEnabled) {\n      // Registration is invalid or not enabled, nothing more to do\n      return;\n    }\n    try {\n      // Since the registration is enabled, fetching a \"new\" device token\n      // shouldn't be a problem.\n      const latestDevicePushToken = await (0, getDevicePushTokenAsync.default)();\n      await updatePushTokenAsync(latestDevicePushToken);\n    } catch (e) {\n      console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n    }\n  }\n  if (ServerRegistrationModule.default.getRegistrationInfoAsync) {\n    // A global scope (to get all the updates) device push token\n    // subscription, never cleared.\n    (0, _TokenEmitter.addPushTokenListener)(async token => {\n      try {\n        // Before updating the push token on server we always check if we should\n        // Since modules can't change their method availability while running, we\n        // can assert it's defined.\n        const registrationInfo = await ServerRegistrationModule.default.getRegistrationInfoAsync();\n        if (!registrationInfo) {\n          // Registration is not enabled\n          return;\n        }\n        const registration = JSON.parse(registrationInfo);\n        if (registration?.isEnabled) {\n          // Dispatch an abortable task to update\n          // registration with new token.\n          await updatePushTokenAsync(token);\n        }\n      } catch (e) {\n        console.warn('[expo-notifications] Error encountered while updating server registration with latest device push token.', e);\n      }\n    });\n    // Verify if persisted registration\n    // has successfully uploaded last known\n    // device push token. If not, retry.\n    ServerRegistrationModule.default.getRegistrationInfoAsync().then(__handlePersistedRegistrationInfoAsync);\n  } else {\n    console.warn(`[expo-notifications] Error encountered while fetching auto-registration state, new tokens will not be automatically registered on server.`, new _expoModulesCore.UnavailabilityError('ServerRegistrationModule', 'getRegistrationInfoAsync'));\n  }\n});","lineCount":100,"map":[[12,2,19,0,"exports"],[12,9,19,0],[12,10,19,0,"setAutoServerRegistrationEnabledAsync"],[12,47,19,0],[12,50,19,0,"setAutoServerRegistrationEnabledAsync"],[12,87,19,0],[13,2,29,0,"exports"],[13,9,29,0],[13,10,29,0,"__handlePersistedRegistrationInfoAsync"],[13,48,29,0],[13,51,29,0,"__handlePersistedRegistrationInfoAsync"],[13,89,29,0],[14,2,1,0,"require"],[14,9,1,0],[14,10,1,0,"_dependencyMap"],[14,24,1,0],[15,2,2,0],[15,6,2,0,"_expoModulesCore"],[15,22,2,0],[15,25,2,0,"require"],[15,32,2,0],[15,33,2,0,"_dependencyMap"],[15,47,2,0],[16,2,3,0],[16,6,3,0,"_ServerRegistrationModule"],[16,31,3,0],[16,34,3,0,"require"],[16,41,3,0],[16,42,3,0,"_dependencyMap"],[16,56,3,0],[17,2,3,0],[17,6,3,0,"ServerRegistrationModule"],[17,30,3,0],[17,33,3,0,"_interopDefault"],[17,48,3,0],[17,49,3,0,"_ServerRegistrationModule"],[17,74,3,0],[18,2,4,0],[18,6,4,0,"_TokenEmitter"],[18,19,4,0],[18,22,4,0,"require"],[18,29,4,0],[18,30,4,0,"_dependencyMap"],[18,44,4,0],[19,2,5,0],[19,6,5,0,"_getDevicePushTokenAsync"],[19,30,5,0],[19,33,5,0,"require"],[19,40,5,0],[19,41,5,0,"_dependencyMap"],[19,55,5,0],[20,2,5,0],[20,6,5,0,"getDevicePushTokenAsync"],[20,29,5,0],[20,32,5,0,"_interopDefault"],[20,47,5,0],[20,48,5,0,"_getDevicePushTokenAsync"],[20,72,5,0],[21,2,6,0],[21,6,6,0,"_utilsUpdateDevicePushTokenAsync"],[21,38,6,0],[21,41,6,0,"require"],[21,48,6,0],[21,49,6,0,"_dependencyMap"],[21,63,6,0],[22,2,7,0],[22,6,7,4,"lastAbortController"],[22,25,7,23],[22,28,7,26],[22,32,7,30],[23,2,8,0],[23,17,8,15,"updatePushTokenAsync"],[23,37,8,35,"updatePushTokenAsync"],[23,38,8,36,"token"],[23,43,8,41],[23,45,8,43],[24,4,9,4],[25,4,10,4,"lastAbortController"],[25,23,10,23],[25,25,10,25,"abort"],[25,30,10,30],[25,31,10,31],[25,32,10,32],[26,4,11,4,"lastAbortController"],[26,23,11,23],[26,26,11,26],[26,30,11,30,"AbortController"],[26,45,11,45],[26,46,11,46],[26,47,11,47],[27,4,12,4],[27,11,12,11],[27,17,12,17],[27,21,12,17,"updateDevicePushTokenAsyncWithSignal"],[27,53,12,53],[27,54,12,53,"updateDevicePushTokenAsync"],[27,80,12,53],[27,82,12,54,"lastAbortController"],[27,101,12,73],[27,102,12,74,"signal"],[27,108,12,80],[27,110,12,82,"token"],[27,115,12,87],[27,116,12,88],[28,2,13,0],[29,2,14,0],[30,0,15,0],[31,0,16,0],[32,0,17,0],[33,0,18,0],[34,2,19,7],[34,17,19,22,"setAutoServerRegistrationEnabledAsync"],[34,54,19,59,"setAutoServerRegistrationEnabledAsync"],[34,55,19,60,"enabled"],[34,62,19,67],[34,64,19,69],[35,4,20,4],[36,4,21,4],[37,4,22,4,"lastAbortController"],[37,23,22,23],[37,25,22,25,"abort"],[37,30,22,30],[37,31,22,31],[37,32,22,32],[38,4,23,4],[38,8,23,8],[38,9,23,9,"ServerRegistrationModule"],[38,33,23,33],[38,34,23,33,"default"],[38,41,23,33],[38,42,23,34,"setRegistrationInfoAsync"],[38,66,23,58],[38,68,23,60],[39,6,24,8],[39,12,24,14],[39,16,24,18,"UnavailabilityError"],[39,32,24,37],[39,33,24,37,"UnavailabilityError"],[39,52,24,37],[39,53,24,38],[39,79,24,64],[39,81,24,66],[39,107,24,92],[39,108,24,93],[40,4,25,4],[41,4,26,4],[41,10,26,10,"ServerRegistrationModule"],[41,34,26,34],[41,35,26,34,"default"],[41,42,26,34],[41,43,26,35,"setRegistrationInfoAsync"],[41,67,26,59],[41,68,26,60,"enabled"],[41,75,26,67],[41,78,26,70,"JSON"],[41,82,26,74],[41,83,26,75,"stringify"],[41,92,26,84],[41,93,26,85],[42,6,26,87,"isEnabled"],[42,15,26,96],[42,17,26,98,"enabled"],[43,4,26,106],[43,5,26,107],[43,6,26,108],[43,9,26,111],[43,13,26,115],[43,14,26,116],[44,2,27,0],[45,2,28,0],[46,2,29,7],[46,17,29,22,"__handlePersistedRegistrationInfoAsync"],[46,55,29,60,"__handlePersistedRegistrationInfoAsync"],[46,56,29,61,"registrationInfo"],[46,72,29,77],[46,74,29,79],[47,4,30,4],[47,8,30,8],[47,9,30,9,"registrationInfo"],[47,25,30,25],[47,27,30,27],[48,6,31,8],[49,6,32,8],[50,4,33,4],[51,4,34,4],[51,8,34,8,"registration"],[51,20,34,20],[51,23,34,23],[51,27,34,27],[52,4,35,4],[52,8,35,8],[53,6,36,8,"registration"],[53,18,36,20],[53,21,36,23,"JSON"],[53,25,36,27],[53,26,36,28,"parse"],[53,31,36,33],[53,32,36,34,"registrationInfo"],[53,48,36,50],[53,49,36,51],[54,4,37,4],[54,5,37,5],[54,6,38,4],[54,13,38,11,"e"],[54,14,38,12],[54,16,38,14],[55,6,39,8,"console"],[55,13,39,15],[55,14,39,16,"warn"],[55,18,39,20],[55,19,39,21],[55,123,39,125],[55,125,39,127,"e"],[55,126,39,128],[55,127,39,129],[56,4,40,4],[57,4,41,4],[57,8,41,8],[57,9,41,9,"registration"],[57,21,41,21],[57,23,41,23,"isEnabled"],[57,32,41,32],[57,34,41,34],[58,6,42,8],[59,6,43,8],[60,4,44,4],[61,4,45,4],[61,8,45,8],[62,6,46,8],[63,6,47,8],[64,6,48,8],[64,12,48,14,"latestDevicePushToken"],[64,33,48,35],[64,36,48,38],[64,42,48,44],[64,46,48,44,"getDevicePushTokenAsync"],[64,69,48,67],[64,70,48,67,"default"],[64,77,48,67],[64,79,48,68],[64,80,48,69],[65,6,49,8],[65,12,49,14,"updatePushTokenAsync"],[65,32,49,34],[65,33,49,35,"latestDevicePushToken"],[65,54,49,56],[65,55,49,57],[66,4,50,4],[66,5,50,5],[66,6,51,4],[66,13,51,11,"e"],[66,14,51,12],[66,16,51,14],[67,6,52,8,"console"],[67,13,52,15],[67,14,52,16,"warn"],[67,18,52,20],[67,19,52,21],[67,125,52,127],[67,127,52,129,"e"],[67,128,52,130],[67,129,52,131],[68,4,53,4],[69,2,54,0],[70,2,55,0],[70,6,55,4,"ServerRegistrationModule"],[70,30,55,28],[70,31,55,28,"default"],[70,38,55,28],[70,39,55,29,"getRegistrationInfoAsync"],[70,63,55,53],[70,65,55,55],[71,4,56,4],[72,4,57,4],[73,4,58,4],[73,8,58,4,"addPushTokenListener"],[73,21,58,24],[73,22,58,24,"addPushTokenListener"],[73,42,58,24],[73,44,58,25],[73,50,58,32,"token"],[73,55,58,37],[73,59,58,42],[74,6,59,8],[74,10,59,12],[75,8,60,12],[76,8,61,12],[77,8,62,12],[78,8,63,12],[78,14,63,18,"registrationInfo"],[78,30,63,34],[78,33,63,37],[78,39,63,43,"ServerRegistrationModule"],[78,63,63,67],[78,64,63,67,"default"],[78,71,63,67],[78,72,63,68,"getRegistrationInfoAsync"],[78,96,63,92],[78,97,63,93],[78,98,63,94],[79,8,64,12],[79,12,64,16],[79,13,64,17,"registrationInfo"],[79,29,64,33],[79,31,64,35],[80,10,65,16],[81,10,66,16],[82,8,67,12],[83,8,68,12],[83,14,68,18,"registration"],[83,26,68,30],[83,29,68,33,"JSON"],[83,33,68,37],[83,34,68,38,"parse"],[83,39,68,43],[83,40,68,44,"registrationInfo"],[83,56,68,60],[83,57,68,61],[84,8,69,12],[84,12,69,16,"registration"],[84,24,69,28],[84,26,69,30,"isEnabled"],[84,35,69,39],[84,37,69,41],[85,10,70,16],[86,10,71,16],[87,10,72,16],[87,16,72,22,"updatePushTokenAsync"],[87,36,72,42],[87,37,72,43,"token"],[87,42,72,48],[87,43,72,49],[88,8,73,12],[89,6,74,8],[89,7,74,9],[89,8,75,8],[89,15,75,15,"e"],[89,16,75,16],[89,18,75,18],[90,8,76,12,"console"],[90,15,76,19],[90,16,76,20,"warn"],[90,20,76,24],[90,21,76,25],[90,127,76,131],[90,129,76,133,"e"],[90,130,76,134],[90,131,76,135],[91,6,77,8],[92,4,78,4],[92,5,78,5],[92,6,78,6],[93,4,79,4],[94,4,80,4],[95,4,81,4],[96,4,82,4,"ServerRegistrationModule"],[96,28,82,28],[96,29,82,28,"default"],[96,36,82,28],[96,37,82,29,"getRegistrationInfoAsync"],[96,61,82,53],[96,62,82,54],[96,63,82,55],[96,64,82,56,"then"],[96,68,82,60],[96,69,82,61,"__handlePersistedRegistrationInfoAsync"],[96,107,82,99],[96,108,82,100],[97,2,83,0],[97,3,83,1],[97,9,84,5],[98,4,85,4,"console"],[98,11,85,11],[98,12,85,12,"warn"],[98,16,85,16],[98,17,85,17],[98,156,85,156],[98,158,85,158],[98,162,85,162,"UnavailabilityError"],[98,178,85,181],[98,179,85,181,"UnavailabilityError"],[98,198,85,181],[98,199,85,182],[98,225,85,208],[98,227,85,210],[98,253,85,236],[98,254,85,237],[98,255,85,238],[99,2,86,0],[100,0,86,1],[100,3]],"functionMap":{"names":["<global>","updatePushTokenAsync","setAutoServerRegistrationEnabledAsync","__handlePersistedRegistrationInfoAsync","addPushTokenListener$argument_0"],"mappings":"AAA;ACO;CDK;OEM;CFQ;OGE;CHyB;yBII;KJoB"},"hasCjsExports":false},"type":"js/module"}]}